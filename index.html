<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>目標管理ホーム</title>
  <style>
    body {
      margin: 0;
      padding: 10px;
      font-family: sans-serif;
      box-sizing: border-box;
    }
    h2 {
      font-size: 18px;
    }
    .controls {
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(20, 1fr);
      grid-template-rows: repeat(10, 1fr);
      width: 100vw;
      height: 80vh;
      gap: 1px;
      border: 1px solid #ccc;
    }
    .cell {
      border: 1px solid #aaa;
      background-color: #fff;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 1px;
      font-size: 0.5vw;
    }
    .cell.selected {
      outline: 2px solid #4285f4;
    }
    .cell textarea {
      width: 100%;
      height: 60%;
      border: none;
      resize: none;
      font-size: 0.5vw;
      padding: 1px;
      box-sizing: border-box;
    }
    .cell img {
      max-width: 100%;
      max-height: 30%;
      object-fit: contain;
      display: block;
    }
    button {
      padding: 4px 6px;
      font-size: 12px;
      cursor: pointer;
    }
    .color-btn, .font-btn {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 0;
    }
    .font-btn {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>

<h2>目標管理・ルーティン管理ホーム</h2>
<div class="controls">
  <button id="mergeBtn">結合</button>
  <button id="splitBtn">分離</button>
  <button id="uploadImageBtn">画像</button>

  <!-- カラー変更ボタン -->
  <button class="color-btn" style="background-color:#f28b82;" data-color="#f28b82"></button>
  <button class="color-btn" style="background-color:#fbbc04;" data-color="#fbbc04"></button>
  <button class="color-btn" style="background-color:#fff475;" data-color="#fff475"></button>
  <button class="color-btn" style="background-color:#ccff90;" data-color="#ccff90"></button>
  <button class="color-btn" style="background-color:#a7ffeb;" data-color="#a7ffeb"></button>
  <button class="color-btn" style="background-color:#d7aefb;" data-color="#d7aefb"></button>
  <button class="color-btn" style="background-color:#e0e0e0;" data-color="#e0e0e0"></button>

  <!-- フォント変更ボタン -->
  <button class="font-btn" data-font="serif" style="font-family: serif;">あ</button>
  <button class="font-btn" data-font="sans-serif" style="font-family: sans-serif;">あ</button>
  <button class="font-btn" data-font='monospace' style="font-family: monospace;">あ</button>
  <button class="font-btn" data-font='"Yu Mincho", "游明朝", serif' style="font-family:'Yu Mincho','游明朝',serif;">あ</button>

  <input type="file" id="imageInput" accept="image/*" style="display: none;" />
</div>

<div class="grid-container" id="grid"></div>

<script>
  const grid = document.getElementById("grid");
  const imageInput = document.getElementById("imageInput");

  const cells = [];
  const selectedCells = new Set();
  const hiddenMap = {};

  // セル生成
  for (let row = 0; row < 10; row++) {
    for (let col = 0; col < 20; col++) {
      const cell = document.createElement("div");
      cell.classList.add("cell");
      cell.dataset.row = row;
      cell.dataset.col = col;

      const textarea = document.createElement("textarea");
      const img = document.createElement("img");
      img.style.display = "none";

      cell.appendChild(textarea);
      cell.appendChild(img);

      cell.addEventListener("click", (e) => {
        const key = `${row},${col}`;
        if (e.ctrlKey || e.metaKey) {
          if (selectedCells.has(key)) {
            selectedCells.delete(key);
            cell.classList.remove("selected");
          } else {
            selectedCells.add(key);
            cell.classList.add("selected");
          }
        } else {
          selectedCells.clear();
          document.querySelectorAll(".cell").forEach(c => c.classList.remove("selected"));
          selectedCells.add(key);
          cell.classList.add("selected");
        }
      });

      grid.appendChild(cell);
      cells.push({ row, col, element: cell });
    }
  }

  function getCell(row, col) {
    return cells.find(c => c.row === row && c.col === col);
  }

  // 結合
  document.getElementById("mergeBtn").addEventListener("click", () => {
    if (selectedCells.size < 2) return alert("2つ以上のセルを選択してください");

    const coords = [...selectedCells].map(c => c.split(',').map(Number));
    const rows = coords.map(c => c[0]);
    const cols = coords.map(c => c[1]);
    const minRow = Math.min(...rows);
    const maxRow = Math.max(...rows);
    const minCol = Math.min(...cols);
    const maxCol = Math.max(...cols);

    const area = (maxRow - minRow + 1) * (maxCol - minCol + 1);
    if (area !== selectedCells.size) {
      return alert("隣接する長方形で選択してください");
    }

    const baseCell = getCell(minRow, minCol).element;
    baseCell.style.gridRow = `${minRow + 1} / span ${maxRow - minRow + 1}`;
    baseCell.style.gridColumn = `${minCol + 1} / span ${maxCol - minCol + 1}`;

    hiddenMap[`${minRow},${minCol}`] = [];
    for (const [r, c] of coords) {
      if (r === minRow && c === minCol) continue;
      const target = getCell(r, c).element;
      target.style.display = "none";
      hiddenMap[`${minRow},${minCol}`].push(`${r},${c}`);
    }

    selectedCells.clear();
    document.querySelectorAll(".cell").forEach(c => c.classList.remove("selected"));
  });

  // 分離
  document.getElementById("splitBtn").addEventListener("click", () => {
    if (selectedCells.size !== 1) return alert("1つの結合セルを選択してください");
    const key = [...selectedCells][0];
    const [row, col] = key.split(',').map(Number);
    const baseCell = getCell(row, col).element;

    if (!(key in hiddenMap)) {
      alert("このセルは結合されていません");
      return;
    }

    baseCell.style.gridRow = "";
    baseCell.style.gridColumn = "";

    for (const hiddenKey of hiddenMap[key]) {
      const [hr, hc] = hiddenKey.split(',').map(Number);
      const cell = getCell(hr, hc).element;
      cell.style.display = "flex";
    }

    delete hiddenMap[key];
    selectedCells.clear();
    document.querySelectorAll(".cell").forEach(c => c.classList.remove("selected"));
  });

  // 画像添付
  document.getElementById("uploadImageBtn").addEventListener("click", () => {
    if (selectedCells.size !== 1) {
      alert("画像は1つのセルにだけ添付できます。1セルのみ選択してください。");
      return;
    }
    imageInput.click();
  });

  imageInput.addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const [row, col] = [...selectedCells][0].split(',').map(Number);
      const cell = getCell(row, col).element;
      const img = cell.querySelector("img");
      img.src = e.target.result;
      img.style.display = "block";
    };
    reader.readAsDataURL(file);
    imageInput.value = "";
  });

  // 色変更
  document.querySelectorAll(".color-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const color = btn.dataset.color;
      selectedCells.forEach(key => {
        const [row, col] = key.split(',').map(Number);
        const cell = getCell(row, col).element;
        const textarea = cell.querySelector("textarea");
        cell.style.backgroundColor = color;
        if (textarea) textarea.style.backgroundColor = color;
      });
    });
  });

  // フォント変更
  document.querySelectorAll(".font-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const font = btn.dataset.font;
      selectedCells.forEach(key => {
        const [row, col] = key.split(',').map(Number);
        const cell = getCell(row, col).element;
        const textarea = cell.querySelector("textarea");
        if (textarea) textarea.style.fontFamily = font;
      });
    });
  });
</script>

</body>
</html>
