<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>目標管理ホーム</title>
  <style>
    body {
      margin: 0;
      padding: 10px;
      font-family: sans-serif;
      box-sizing: border-box;
    }
    h2 {
      font-size: 18px;
    }
    .controls {
      margin-bottom: 10px;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(20, 1fr);
      grid-template-rows: repeat(10, 1fr);
      width: 100vw;
      height: 80vh;
      gap: 1px;
      border: 1px solid #ccc;
    }
    .cell {
      border: 1px solid #aaa;
      background-color: #fff;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 1px;
      font-size: 0.5vw;
    }
    .cell.selected {
      outline: 2px solid #4285f4;
    }
    .cell textarea {
      width: 100%;
      height: 60%;
      border: none;
      resize: none;
      font-size: 0.5vw;
      padding: 1px;
      box-sizing: border-box;
    }
    .cell img {
      max-width: 100%;
      max-height: 30%;
      object-fit: contain;
      display: block;
    }
    .cell select {
      font-size: 0.5vw;
      width: 100%;
    }
    button {
      margin-right: 6px;
      padding: 4px 8px;
      font-size: 12px;
    }
  </style>
</head>
<body>

<h2>目標管理・ルーティン管理ホーム</h2>
<div class="controls">
  <button id="mergeBtn">選択セルを結合</button>
  <button id="splitBtn">選択セルを分割</button>
  <button id="uploadImageBtn">画像を添付</button>
  <input type="file" id="imageInput" accept="image/*" style="display: none;" />
</div>
<div class="grid-container" id="grid"></div>

<script>
  const grid = document.getElementById("grid");
  const imageInput = document.getElementById("imageInput");

  const colorOptions = [
    { name: "なし", value: "" },
    { name: "赤", value: "#f28b82" },
    { name: "橙", value: "#fbbc04" },
    { name: "黄", value: "#fff475" },
    { name: "緑", value: "#ccff90" },
    { name: "青", value: "#a7ffeb" },
    { name: "紫", value: "#d7aefb" },
    { name: "灰", value: "#e0e0e0" },
  ];

  const cells = [];
  const selectedCells = new Set();
  const hiddenMap = {};

  for (let row = 0; row < 10; row++) {
    for (let col = 0; col < 20; col++) {
      const cell = document.createElement("div");
      cell.classList.add("cell");
      cell.dataset.row = row;
      cell.dataset.col = col;

      const textarea = document.createElement("textarea");

      const img = document.createElement("img");
      img.style.display = "none";

      const colorSelect = document.createElement("select");
      colorOptions.forEach(opt => {
        const option = document.createElement("option");
        option.textContent = opt.name;
        option.value = opt.value;
        colorSelect.appendChild(option);
      });

      colorSelect.addEventListener("change", () => {
        cell.style.backgroundColor = colorSelect.value;
      });

      cell.appendChild(textarea);
      cell.appendChild(img);
      cell.appendChild(colorSelect);

      cell.addEventListener("click", (e) => {
        const key = `${row},${col}`;
        if (e.ctrlKey || e.metaKey) {
          if (selectedCells.has(key)) {
            selectedCells.delete(key);
            cell.classList.remove("selected");
          } else {
            selectedCells.add(key);
            cell.classList.add("selected");
          }
        } else {
          selectedCells.clear();
          document.querySelectorAll(".cell").forEach(c => c.classList.remove("selected"));
          selectedCells.add(key);
          cell.classList.add("selected");
        }
      });

      grid.appendChild(cell);
      cells.push({ row, col, element: cell });
    }
  }

  function getCell(row, col) {
    return cells.find(c => c.row === row && c.col === col);
  }

  function mergeCells() {
    if (selectedCells.size < 2) return alert("2つ以上のセルを選択してください");

    const coords = [...selectedCells].map(c => c.split(',').map(Number));
    const rows = coords.map(c => c[0]);
    const cols = coords.map(c => c[1]);
    const minRow = Math.min(...rows);
    const maxRow = Math.max(...rows);
    const minCol = Math.min(...cols);
    const maxCol = Math.max(...cols);

    const area = (maxRow - minRow + 1) * (maxCol - minCol + 1);
    if (area !== selectedCells.size) {
      return alert("隣接する長方形で選択してください");
    }

    const baseCell = getCell(minRow, minCol).element;
    baseCell.style.gridRow = `${minRow + 1} / span ${maxRow - minRow + 1}`;
    baseCell.style.gridColumn = `${minCol + 1} / span ${maxCol - minCol + 1}`;

    hiddenMap[`${minRow},${minCol}`] = [];
    for (const [r, c] of coords) {
      if (r === minRow && c === minCol) continue;
      const target = getCell(r, c).element;
      target.style.display = "none";
      hiddenMap[`${minRow},${minCol}`].push(`${r},${c}`);
    }

    selectedCells.clear();
    document.querySelectorAll(".cell").forEach(c => c.classList.remove("selected"));
  }

  function splitCell() {
    if (selectedCells.size !== 1) return alert("1つの結合セルを選択してください");
    const key = [...selectedCells][0];
    const [row, col] = key.split(',').map(Number);
    const baseCell = getCell(row, col).element;

    if (!(key in hiddenMap)) {
      alert("このセルは結合されていません");
      return;
    }

    baseCell.style.gridRow = "";
    baseCell.style.gridColumn = "";

    for (const hiddenKey of hiddenMap[key]) {
      const [hr, hc] = hiddenKey.split(',').map(Number);
      const cell = getCell(hr, hc).element;
      cell.style.display = "flex";
    }

    delete hiddenMap[key];
    selectedCells.clear();
    document.querySelectorAll(".cell").forEach(c => c.classList.remove("selected"));
  }

  document.getElementById("mergeBtn").addEventListener("click", mergeCells);
  document.getElementById("splitBtn").addEventListener("click", splitCell);

  document.getElementById("uploadImageBtn").addEventListener("click", () => {
    if (selectedCells.size !== 1) {
      alert("画像は1つのセルにだけ添付できます。1セルのみ選択してください。");
      return;
    }
    imageInput.click();
  });

  imageInput.addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const [row, col] = [...selectedCells][0].split(',').map(Number);
      const cell = getCell(row, col).element;
      const img = cell.querySelector("img");
      img.src = e.target.result;
      img.style.display = "block";
    };
    reader.readAsDataURL(file);
    imageInput.value = "";
  });
</script>

</body>
</html>
