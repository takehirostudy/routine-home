<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brain Hacker</title>
  <style>
    body { margin: 0; padding: 10px; font-family: sans-serif; }
    .controls { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(20, 1fr);
      grid-template-rows: repeat(16, 1fr);
      width: 100vw;
      height: 80vh;
      gap: 1px;
      border: 1px solid #ccc;
    }
    .cell {
      border: 1px solid #aaa;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 1px;
      font-size: 1vw;
    }
    .cell.selected { outline: 2px solid #4285f4; }
    .editable {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      flex-direction: column;
      font-size: 1vw;
      text-align: left;
      padding: 2px;
      border: none;
      outline: none;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .cell img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    button {
      padding: 4px 6px;
      font-size: 12px;
      cursor: pointer;
    }
    .size-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 4px;
      background-color: #f0f0f0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .title-input {
      font-size: 2em;
      width: 100%;
      border: none;
      color: black;
      outline: none;
      text-align: center;
    }
    .title-input::placeholder {
      color: #bbb;
    }
    #dateDisplay {
      font-weight: bold;
      font-size: 1.2em;
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <div id="dateDisplay"></div>
  <input class="title-input" id="pageTitle" placeholder="Brain hacker" />
  <div class="controls" id="controls">
    <!-- buttons omitted for brevity -->
  </div>
  <div class="grid-container" id="grid"></div>
  <script>
    const grid = document.getElementById("grid");
    const titleInput = document.getElementById("pageTitle");
    const selectedCells = new Set();
    let history = [], historyIndex = -1;
    let currentDateKey = "";

    function getTodayKey() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function getDayName() {
      const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      return days[new Date().getDay()];
    }

    function updateDateDisplay() {
      const todayKey = getTodayKey();
      const day = getDayName();
      const dateDisplay = document.getElementById("dateDisplay");
      dateDisplay.textContent = `${todayKey} (${day})`;
    }

    function createGrid() {
      for (let row = 0; row < 16; row++) {
        for (let col = 0; col < 20; col++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.row = row;
          cell.dataset.col = col;

          const editable = document.createElement("div");
          editable.className = "editable";
          editable.contentEditable = true;
          editable.addEventListener("input", saveState);

          const img = document.createElement("img");
          img.style.display = "none";

          cell.appendChild(editable);
          cell.appendChild(img);

          grid.appendChild(cell);
        }
      }
    }

    function getCell(row, col) {
      return [...grid.children].find(c => c.dataset.row == row && c.dataset.col == col);
    }

    function saveState() {
      const state = [...grid.children].map(cell => {
        const editable = cell.querySelector(".editable");
        const img = cell.querySelector("img");
        editable.querySelectorAll("input[type='checkbox']").forEach(cb => {
          if (cb.checked) {
            cb.setAttribute("checked", "checked");
          } else {
            cb.removeAttribute("checked");
          }
        });
        return {
          row: cell.dataset.row,
          col: cell.dataset.col,
          html: editable.innerHTML,
          fontSize: editable.style.fontSize,
          bgColor: cell.style.backgroundColor,
          display: cell.style.display,
          gridRow: cell.style.gridRow,
          gridColumn: cell.style.gridColumn,
          imgSrc: img?.src || '',
          alignItems: editable.style.alignItems,
          justifyContent: editable.style.justifyContent,
          textAlign: editable.style.textAlign
        };
      });
      localStorage.setItem(`brainhack-${currentDateKey}`, JSON.stringify(state));
      localStorage.setItem("pageTitle", titleInput.value);
      history = history.slice(0, historyIndex + 1);
      history.push(JSON.stringify(state));
      historyIndex++;
    }

    function restoreState() {
      const saved = localStorage.getItem(`brainhack-${currentDateKey}`);
      const savedTitle = localStorage.getItem("pageTitle");
      if (savedTitle) titleInput.value = savedTitle;
      if (!saved) return;
      const state = JSON.parse(saved);
      state.forEach(data => {
        const cell = getCell(data.row, data.col);
        const editable = cell.querySelector(".editable");
        const img = cell.querySelector("img");
        editable.innerHTML = data.html || '';
        editable.querySelectorAll("input[type='checkbox']").forEach(cb => {
          cb.checked = cb.checked || cb.hasAttribute('checked');
          const span = cb.nextElementSibling;
          if (cb.checked) {
            if (span) span.style.textDecoration = "line-through";
          } else {
            if (span) span.style.textDecoration = "none";
          }
          cb.addEventListener("change", () => {
            if (span) span.style.textDecoration = cb.checked ? "line-through" : "none";
            saveState();
          });
        });
        editable.style.fontSize = data.fontSize || '';
        editable.style.alignItems = data.alignItems || 'flex-start';
        editable.style.justifyContent = data.justifyContent || 'flex-start';
        editable.style.textAlign = data.textAlign || 'left';
        cell.style.backgroundColor = data.bgColor || '';
        cell.style.display = data.display || 'flex';
        cell.style.gridRow = data.gridRow || '';
        cell.style.gridColumn = data.gridColumn || '';
        if (data.imgSrc) {
          img.src = data.imgSrc;
          img.style.display = 'block';
        }
      });
    }

    function checkDateAndArchive() {
      currentDateKey = getTodayKey();
      updateDateDisplay();
      restoreState();
      setInterval(() => {
        const nowKey = getTodayKey();
        if (nowKey !== currentDateKey) {
          saveState();
          currentDateKey = nowKey;
          updateDateDisplay();
          localStorage.setItem("pageTitle", "");
          location.reload();
        }
      }, 60000);
    }

    window.onload = () => {
      checkDateAndArchive();
      createGrid();
    };
  </script>
</body>
</html>
